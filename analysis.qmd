---
title: "iNaturalist vs. Traditional Data Sources: A Comparative Analysis of Sensitive Species Records in California"
author: "Kyle Nessen"
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    code-fold: true
    fig-width: 10
    fig-height: 6
    embed-resources: true
  pdf:
    toc: true
    fig-width: 8
    fig-height: 5
execute:
  warning: false
  message: false
  cache: true
---



# CNDDB
## Load data

```{r load-cnddb}
library(sf)

# Load CNDDB shapefile
cnddb <- st_read("data/gis_com/cnddb.shp")
```

## Find unique species names and counts

```{r species-analysis}
library(dplyr)
library(lubridate)
library(stringr)

# Convert SITEDATE to proper date format and clean species names
cnddb_clean <- cnddb %>%
    mutate(
        # Handle various date formats in SITEDATE
        site_date = case_when(
            nchar(SITEDATE) == 8 & !grepl("X", SITEDATE) ~ ymd(SITEDATE),
            nchar(SITEDATE) == 8 & grepl("XXXX$", SITEDATE) ~ ymd(paste0(substr(SITEDATE, 1, 4), "0101")),
            TRUE ~ as.Date(NA)
        ),
        # Flag records from last 3 years
        recent_record = !is.na(site_date) & site_date >= (Sys.Date() - years(3)),
        # Clean species names for better GBIF matching
        SNAME_clean = SNAME %>%
            str_remove_all(" pop\\. \\d+") %>%
            str_replace_all(" ssp\\. ", " ") %>%
            str_replace_all(" var\\. ", " ") %>%
            str_trim() %>%
            str_squish()
    )

# Species summary with counts and recent records (grouped by cleaned names)
species_summary <- cnddb_clean %>%
    st_drop_geometry() %>%
    group_by(SNAME_clean) %>%
    summarise(
        total_records = n(),
        recent_records = sum(recent_record, na.rm = TRUE),
        earliest_date = min(site_date, na.rm = TRUE),
        latest_date = max(site_date, na.rm = TRUE),
        # Keep track of original names for reference
        original_names = paste(unique(SNAME), collapse = "; "),
        common_names = paste(unique(CNAME), collapse = "; "),
        .groups = "drop"
    ) %>%
    arrange(desc(total_records))

# Display summary statistics
cat("Total unique species:", nrow(species_summary), "\n")
cat("Species with records in last 3 years:", sum(species_summary$recent_records > 0), "\n")
cat("Total recent records:", sum(species_summary$recent_records), "\n")

# Show top species by record count
head(species_summary, 10)

# Save species list for GBIF queries
cnddb_species_list <- species_summary %>%
  select(SNAME_clean, original_names, common_names, total_records, recent_records) %>%
  arrange(SNAME_clean)

# Export to CSV for reference
write.csv(cnddb_species_list, "data/cnddb_species_list.csv", row.names = FALSE)

cat("Species list saved to data/cnddb_species_list.csv\n")
cat("Total species for GBIF queries:", nrow(cnddb_species_list), "\n")
```

# GBIF Data

Load the GBIF occurrence data downloaded via gbif_download.qmd

```{r load-gbif}
library(readr)

# Check if GBIF data exists
if(!file.exists("data/gbif_occurrences.csv")) {
  stop("GBIF data not found. Run gbif_download.qmd first to download the data.")
}

# Load GBIF occurrences
gbif_data <- read_csv("data/gbif_occurrences.csv")

# Load the matching information
gbif_matches <- read_csv("data/gbif_good_matches.csv")

# Basic summary
cat("GBIF Records Summary:\n")
cat("Total records:", nrow(gbif_data), "\n")
cat("Unique species:", length(unique(gbif_data$species)), "\n")
cat("Date range:", min(gbif_data$eventDate, na.rm = TRUE), "to", max(gbif_data$eventDate, na.rm = TRUE), "\n")

# Show data structure
head(gbif_data)
```