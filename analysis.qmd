---
title: "iNaturalist vs. Traditional Data Sources: A Comparative Analysis of Sensitive Species Records in California"
author: "Kyle Nessen"
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    code-fold: true
    fig-width: 10
    fig-height: 6
    embed-resources: true
  pdf:
    toc: true
    fig-width: 8
    fig-height: 5
execute:
  warning: false
  message: false
  cache: true
---



# CNDDB
## Load data

```{r load-cnddb}
library(sf)

# Load CNDDB shapefile
cnddb <- st_read("data/gis_com/cnddb.shp")
```

## Find unique species names and counts

```{r species-analysis}
library(dplyr)
library(lubridate)
library(stringr)

# Convert SITEDATE to proper date format and clean species names
cnddb_clean <- cnddb %>%
    mutate(
        # Handle various date formats in SITEDATE
        site_date = case_when(
            nchar(SITEDATE) == 8 & !grepl("X", SITEDATE) ~ ymd(SITEDATE),
            nchar(SITEDATE) == 8 & grepl("XXXX$", SITEDATE) ~ ymd(paste0(substr(SITEDATE, 1, 4), "0101")),
            TRUE ~ as.Date(NA)
        ),
        # Flag records from last 3 years
        recent_record = !is.na(site_date) & site_date >= (Sys.Date() - years(3)),
        # Clean species names for better GBIF matching
        SNAME_clean = SNAME %>%
            str_remove_all(" pop\\. \\d+") %>%
            str_replace_all(" ssp\\. ", " ") %>%
            str_replace_all(" var\\. ", " ") %>%
            str_trim() %>%
            str_squish()
    )

# Species summary with counts and recent records (grouped by cleaned names)
species_summary <- cnddb_clean %>%
    st_drop_geometry() %>%
    group_by(SNAME_clean) %>%
    summarise(
        total_records = n(),
        recent_records = sum(recent_record, na.rm = TRUE),
        earliest_date = min(site_date, na.rm = TRUE),
        latest_date = max(site_date, na.rm = TRUE),
        # Keep track of original names for reference
        original_names = paste(unique(SNAME), collapse = "; "),
        common_names = paste(unique(CNAME), collapse = "; "),
        .groups = "drop"
    ) %>%
    arrange(desc(total_records))

# Display summary statistics
cat("Total unique species:", nrow(species_summary), "\n")
cat("Species with records in last 3 years:", sum(species_summary$recent_records > 0), "\n")
cat("Total recent records:", sum(species_summary$recent_records), "\n")

# Show top species by record count
head(species_summary, 10)

# Save species list for GBIF queries
cnddb_species_list <- species_summary %>%
    select(SNAME_clean, original_names, common_names, total_records, recent_records) %>%
    arrange(SNAME_clean)

# Export to CSV for reference
write.csv(cnddb_species_list, "data/cnddb_species_list.csv", row.names = FALSE)

cat("Species list saved to data/cnddb_species_list.csv\n")
cat("Total species for GBIF queries:", nrow(cnddb_species_list), "\n")
```

# GBIF

## Download the data

See `gbif_download.qmd` for code on requesting the batch download.

## Load the GBIF occurrence data

```{r load-gbif}
library(data.table)

# Check if GBIF data exists
if (!file.exists("data/0050088-250525065834625.csv")) {
    stop("GBIF data not found. Run gbif_download.qmd first to download the data.")
}

# Load GBIF occurrences - using fread() as it handles GBIF tab-delimited CSV files better
gbif_data <- fread("data/0050088-250525065834625.csv")

```

## Remove birds
Looking at the records, the observations are overwhelmed by eBird sightings. Because protections around birds are a bit odd (only nesting), I am going to remove them to avoid blowing up the signal from eBird.



```{r institution-analysis}
library(ggplot2)

# Count records by institutionCode
inst_counts <- gbif_data[, .N, by = institutionCode][order(-N)]

# Show top 10 institutions
head(inst_counts, 10)

# Plot histogram (bar plot) of record counts by institutionCode (top 20 for readability)
top_n <- 20
inst_counts_top <- inst_counts[1:top_n]

ggplot(inst_counts_top, aes(x = reorder(institutionCode, -N), y = N)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    labs(
        title = paste("Top", top_n, "Institutions by Record Count (GBIF)"),
        x = "Institution Code",
        y = "Number of Records"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r filter-birds}
# Check bird records before filtering
cat("Total records before filtering:", nrow(gbif_data), "\n")
cat("Bird records (class = Aves):", nrow(gbif_data[class == "Aves"]), "\n")

# Filter out birds (class = "Aves")
gbif_data <- gbif_data[class != "Aves" | is.na(class)]

cat("Total records after removing birds:", nrow(gbif_data), "\n")
```
```{r institution-analysis}
library(ggplot2)

# Count records by institutionCode
inst_counts <- gbif_data[, .N, by = institutionCode][order(-N)]

# Show top 10 institutions
head(inst_counts, 10)

# Plot histogram (bar plot) of record counts by institutionCode (top 20 for readability)
top_n <- 20
inst_counts_top <- inst_counts[1:top_n]

ggplot(inst_counts_top, aes(x = reorder(institutionCode, -N), y = N)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    labs(
        title = paste("Top", top_n, "Institutions by Record Count (GBIF)"),
        x = "Institution Code",
        y = "Number of Records"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## GBIF Species Summary

```{r gbif-species-summary}
# Create species summary for GBIF data
gbif_species_summary <- gbif_data[
  !is.na(species) & !is.na(year),  # Filter out records without species or year
  .(
    usageKey = first(na.omit(taxonKey)),  # Keep usageKey as requested
    total_records = .N,
    recent_records = sum(year >= (year(Sys.Date()) - 3), na.rm = TRUE),
    recent_inaturalist_records = sum(year >= (year(Sys.Date()) - 3) & 
                                   (institutionCode == "iNaturalist" | 
                                    institutionCode == "iNat" | 
                                    grepl("iNaturalist", institutionCode, ignore.case = TRUE)), na.rm = TRUE),
    recent_other_records = sum(year >= (year(Sys.Date()) - 3) & 
                             !(institutionCode == "iNaturalist" | 
                               institutionCode == "iNat" | 
                               grepl("iNaturalist", institutionCode, ignore.case = TRUE)) & 
                             !is.na(institutionCode), na.rm = TRUE),
    inaturalist_records = sum(institutionCode == "iNaturalist" | 
                             institutionCode == "iNat" | 
                             grepl("iNaturalist", institutionCode, ignore.case = TRUE), na.rm = TRUE),
    other_institution_records = sum(!(institutionCode == "iNaturalist" | 
                                     institutionCode == "iNat" | 
                                     grepl("iNaturalist", institutionCode, ignore.case = TRUE)) & 
                                   !is.na(institutionCode), na.rm = TRUE),
    earliest_year = min(year, na.rm = TRUE),
    latest_year = max(year, na.rm = TRUE),
    top_institutions = paste(head(names(sort(table(institutionCode), decreasing = TRUE)), 3), collapse = "; ")
  ),
  by = species
][order(-total_records)]

# Display summary statistics
cat("Total unique species in GBIF data:", nrow(gbif_species_summary), "\n")
cat("Species with records in last 3 years:", sum(gbif_species_summary$recent_records > 0), "\n")
cat("Species with recent iNaturalist records:", sum(gbif_species_summary$recent_inaturalist_records > 0), "\n")
cat("Species with recent other institution records:", sum(gbif_species_summary$recent_other_records > 0), "\n")
cat("Total recent records:", sum(gbif_species_summary$recent_records), "\n")
cat("Total recent iNaturalist records:", sum(gbif_species_summary$recent_inaturalist_records), "\n")
cat("Total recent other institution records:", sum(gbif_species_summary$recent_other_records), "\n")
cat("Total iNaturalist records:", sum(gbif_species_summary$inaturalist_records), "\n")

# Show top species by record count
head(gbif_species_summary, 15)
```

# Combined Analysis: iNaturalist vs. All Others

## Combine CNDDB and GBIF Data

```{r combine-datasets}
# Load the GBIF good matches to get usageKey mappings
if (!file.exists("data/gbif_good_matches.csv")) {
    stop("GBIF good matches file not found. This file should contain usageKey mappings.")
}

gbif_matches <- fread("data/gbif_good_matches.csv")

# Create a mapping from species names to usageKey
species_to_usagekey <- gbif_matches[, .(species = verbatim_name, usageKey)]

# Combine CNDDB data with GBIF data using usageKey
# First, get CNDDB species with their usageKeys
cnddb_with_usagekey <- merge(
    cnddb_species_list, 
    species_to_usagekey, 
    by.x = "SNAME_clean", 
    by.y = "species", 
    all.x = TRUE
)

# Convert to data.table for easier manipulation
cnddb_with_usagekey <- as.data.table(cnddb_with_usagekey)

# For species that matched, get their GBIF data
matched_species <- cnddb_with_usagekey[!is.na(usageKey)]
cat("CNDDB species with GBIF matches:", nrow(matched_species), "out of", nrow(cnddb_species_list), "\n")

# Create combined summary for matched species
if (nrow(matched_species) > 0) {
    # Get GBIF data for matched species
    gbif_matched <- merge(
        gbif_species_summary,
        matched_species[, .(species = SNAME_clean, usageKey, cnddb_records = total_records, cnddb_recent = recent_records)],
        by.x = "usageKey",
        by.y = "usageKey",
        all.y = TRUE
    )
    
    # Replace NA values with 0 for species not found in GBIF
    gbif_matched[is.na(total_records), total_records := 0]
    gbif_matched[is.na(inaturalist_records), inaturalist_records := 0]
    gbif_matched[is.na(other_institution_records), other_institution_records := 0]
    gbif_matched[is.na(recent_inaturalist_records), recent_inaturalist_records := 0]
    gbif_matched[is.na(recent_other_records), recent_other_records := 0]
    
    # Create the combined summary
    combined_summary <- gbif_matched[, .(
        species_name = species.y,
        usageKey = usageKey,
        # CNDDB (sensitive species database)
        cnddb_records = cnddb_records,
        cnddb_recent_records = cnddb_recent,
        # iNaturalist 
        inaturalist_records = inaturalist_records,
        inaturalist_recent_records = recent_inaturalist_records,
        # All others (GBIF other institutions + CNDDB)
        other_gbif_records = other_institution_records,
        other_gbif_recent_records = recent_other_records,
        # Combined "all others" category
        all_others_records = cnddb_records + other_institution_records,
        all_others_recent_records = cnddb_recent + recent_other_records,
        # Total records
        total_all_records = cnddb_records + inaturalist_records + other_institution_records
    )][order(-total_all_records)]
    
    cat("Combined analysis ready for", nrow(combined_summary), "species\n")
    head(combined_summary, 10)
} else {
    cat("No species matches found between CNDDB and GBIF\n")
}
```

## Summary Statistics Comparison

```{r summary-comparison}
if (exists("combined_summary") && nrow(combined_summary) > 0) {
    # Calculate aggregate statistics
    total_species <- nrow(combined_summary)
    
    # Total records
    total_cnddb <- sum(combined_summary$cnddb_records)
    total_inaturalist <- sum(combined_summary$inaturalist_records)
    total_other_gbif <- sum(combined_summary$other_gbif_records)
    total_all_others <- sum(combined_summary$all_others_records)
    
    # Recent records (last 3 years)
    recent_cnddb <- sum(combined_summary$cnddb_recent_records)
    recent_inaturalist <- sum(combined_summary$inaturalist_recent_records)
    recent_other_gbif <- sum(combined_summary$other_gbif_recent_records)
    recent_all_others <- sum(combined_summary$all_others_recent_records)
    
    # Species with any records
    species_with_cnddb <- sum(combined_summary$cnddb_records > 0)
    species_with_inaturalist <- sum(combined_summary$inaturalist_records > 0)
    species_with_all_others <- sum(combined_summary$all_others_records > 0)
    
    # Species with recent records
    species_with_recent_cnddb <- sum(combined_summary$cnddb_recent_records > 0)
    species_with_recent_inaturalist <- sum(combined_summary$inaturalist_recent_records > 0)
    species_with_recent_all_others <- sum(combined_summary$all_others_recent_records > 0)
    
    # Print summary
    cat("=== SUMMARY STATISTICS ===\n")
    cat("Total species analyzed:", total_species, "\n\n")
    
    cat("TOTAL RECORDS:\n")
    cat("  CNDDB (sensitive species):", formatC(total_cnddb, format = "d", big.mark = ","), "\n")
    cat("  iNaturalist:", formatC(total_inaturalist, format = "d", big.mark = ","), "\n")
    cat("  Other GBIF institutions:", formatC(total_other_gbif, format = "d", big.mark = ","), "\n")
    cat("  All Others (CNDDB + Other GBIF):", formatC(total_all_others, format = "d", big.mark = ","), "\n\n")
    
    cat("RECENT RECORDS (last 3 years):\n")
    cat("  CNDDB:", formatC(recent_cnddb, format = "d", big.mark = ","), "\n")
    cat("  iNaturalist:", formatC(recent_inaturalist, format = "d", big.mark = ","), "\n")
    cat("  Other GBIF institutions:", formatC(recent_other_gbif, format = "d", big.mark = ","), "\n")
    cat("  All Others (CNDDB + Other GBIF):", formatC(recent_all_others, format = "d", big.mark = ","), "\n\n")
    
    cat("SPECIES COVERAGE:\n")
    cat("  Species with CNDDB records:", species_with_cnddb, "out of", total_species, 
        sprintf("(%.1f%%)", 100 * species_with_cnddb / total_species), "\n")
    cat("  Species with iNaturalist records:", species_with_inaturalist, "out of", total_species,
        sprintf("(%.1f%%)", 100 * species_with_inaturalist / total_species), "\n")
    cat("  Species with All Others records:", species_with_all_others, "out of", total_species,
        sprintf("(%.1f%%)", 100 * species_with_all_others / total_species), "\n\n")
    
    cat("RECENT SPECIES COVERAGE:\n")
    cat("  Species with recent CNDDB records:", species_with_recent_cnddb, "out of", total_species,
        sprintf("(%.1f%%)", 100 * species_with_recent_cnddb / total_species), "\n")
    cat("  Species with recent iNaturalist records:", species_with_recent_inaturalist, "out of", total_species,
        sprintf("(%.1f%%)", 100 * species_with_recent_inaturalist / total_species), "\n")
    cat("  Species with recent All Others records:", species_with_recent_all_others, "out of", total_species,
        sprintf("(%.1f%%)", 100 * species_with_recent_all_others / total_species), "\n")
}
```

## Visualization: iNaturalist vs. All Others

```{r comparison-visualization}
if (exists("combined_summary") && nrow(combined_summary) > 0) {
    library(ggplot2)
    library(scales)
    
    # Create summary data for visualization
    viz_data <- data.frame(
        Category = c("iNaturalist", "All Others (CNDDB + Other GBIF)"),
        Total_Records = c(total_inaturalist, total_all_others),
        Recent_Records = c(recent_inaturalist, recent_all_others),
        Species_Coverage = c(species_with_inaturalist, species_with_all_others),
        Recent_Species_Coverage = c(species_with_recent_inaturalist, species_with_recent_all_others)
    )
    
    # Plot 1: Total Records Comparison
    p1 <- ggplot(viz_data, aes(x = Category, y = Total_Records, fill = Category)) +
        geom_bar(stat = "identity", alpha = 0.8) +
        scale_fill_manual(values = c("iNaturalist" = "#74c476", "All Others (CNDDB + Other GBIF)" = "#2b8cbe")) +
        scale_y_continuous(labels = comma_format()) +
        labs(
            title = "Total Records: iNaturalist vs. All Others",
            subtitle = "Comparison of sensitive species occurrence records",
            x = "", 
            y = "Number of Records"
        ) +
        theme_minimal() +
        theme(
            legend.position = "none",
            axis.text.x = element_text(angle = 45, hjust = 1),
            plot.title = element_text(hjust = 0.5),
            plot.subtitle = element_text(hjust = 0.5)
        )
    
    print(p1)
    
    # Plot 2: Recent Records Comparison
    p2 <- ggplot(viz_data, aes(x = Category, y = Recent_Records, fill = Category)) +
        geom_bar(stat = "identity", alpha = 0.8) +
        scale_fill_manual(values = c("iNaturalist" = "#74c476", "All Others (CNDDB + Other GBIF)" = "#2b8cbe")) +
        scale_y_continuous(labels = comma_format()) +
        labs(
            title = "Recent Records (Last 3 Years): iNaturalist vs. All Others",
            subtitle = "Comparison of recent sensitive species occurrence records",
            x = "", 
            y = "Number of Records"
        ) +
        theme_minimal() +
        theme(
            legend.position = "none",
            axis.text.x = element_text(angle = 45, hjust = 1),
            plot.title = element_text(hjust = 0.5),
            plot.subtitle = element_text(hjust = 0.5)
        )
    
    print(p2)
    
    # Plot 3: Species Coverage Comparison
    p3 <- ggplot(viz_data, aes(x = Category, y = Species_Coverage, fill = Category)) +
        geom_bar(stat = "identity", alpha = 0.8) +
        scale_fill_manual(values = c("iNaturalist" = "#74c476", "All Others (CNDDB + Other GBIF)" = "#2b8cbe")) +
        labs(
            title = "Species Coverage: iNaturalist vs. All Others",
            subtitle = paste("Number of species with records out of", total_species, "total species"),
            x = "", 
            y = "Number of Species with Records"
        ) +
        theme_minimal() +
        theme(
            legend.position = "none",
            axis.text.x = element_text(angle = 45, hjust = 1),
            plot.title = element_text(hjust = 0.5),
            plot.subtitle = element_text(hjust = 0.5)
        )
    
    print(p3)
}
```

